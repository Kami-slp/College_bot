import telebot
import ollama
from telebot import types
from io import BytesIO
from Only_functions import *

API_TOKEN = '8150565426:AAFVcl9ULFaz3BTVf5hDm9jSh4cLeiRt8SU'
bot = telebot.TeleBot(API_TOKEN)


user_state = {}




def format_dataframe_preview(df, max_rows=5):
    preview_df = df.head(max_rows)

    col_widths = {
        col: max(len(str(col)), preview_df[col].astype(str).str.len().max())
        for col in preview_df.columns
    }

    lines = []
    lines.append(" | ".join(str(col).ljust(col_widths[col]) for col in preview_df.columns))

    for _, row in preview_df.iterrows():
        lines.append(" | ".join(str(row[col]).ljust(col_widths[col]) for col in preview_df.columns))

    return "\n".join(lines)


def main_menu():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row('üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è', 'üßë‚Äçüè´ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π')
    markup.row('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –î–ó', 'üìù –¢–µ–º—ã —É—Ä–æ–∫–æ–≤')
    markup.row('üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'üë®‚Äçüéì –û—Ç—á–µ—Ç –ø–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º')
    markup.row('ü§ñ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏')
    return markup




@bot.message_handler(commands=['start'])
def start(message):
    user_state.pop(message.chat.id, None)
    bot.send_message(
        message.chat.id,
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —É—á–µ–±–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:",
        reply_markup=main_menu()
    )




@bot.message_handler(func=lambda m: m.text in [
    'üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è',
    'üßë‚Äçüè´ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π',
    '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –î–ó',
    'üìù –¢–µ–º—ã —É—Ä–æ–∫–æ–≤',
    'üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã',
    'üë®‚Äçüéì –û—Ç—á–µ—Ç –ø–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º',
    'ü§ñ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏'
])
def choose_mode(message):
    chat_id = message.chat.id
    text = message.text


    if text == 'ü§ñ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏':
        user_state[chat_id] = {
            "mode": "consultant",
            "report_type": None
        }

        bot.send_message(
            chat_id,
            "ü§ñ *–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏*\n\n"
            "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å:\n"
            "‚Ä¢ –∞–Ω–∞–ª–∏–∑–æ–º —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏\n"
            "‚Ä¢ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –≥—Ä—É–ø–ø–∞–º–∏\n"
            "‚Ä¢ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏ –ø—Ä–∏–∫–∞–∑–æ–≤ –∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö –∑–∞–ø–∏—Å–æ–∫\n"
            "‚Ä¢ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –∫ –ø—Ä–æ–≤–µ—Ä–∫–∞–º –∏ –ø–µ–¥—Å–æ–≤–µ—Ç–∞–º\n\n"
            "–û–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º.",
            parse_mode="Markdown"
        )
        return


    user_state[chat_id] = {
        "mode": "report",
        "report_type": text
    }

    descriptions = {
        'üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã': "üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º.",
        'üìù –¢–µ–º—ã —É—Ä–æ–∫–æ–≤': "üìù –¢–µ–º—ã, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ä–º–∞—Ç—É.",
        '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –î–ó': "‚úÖ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ —Å –Ω–∏–∑–∫–∏–º % –ø—Ä–æ–≤–µ—Ä–∫–∏ –î–ó.",
        'üßë‚Äçüè´ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π': "üìâ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –Ω–∏–∂–µ –Ω–æ—Ä–º—ã.",
        'üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è': "üìå –°—Ç—É–¥–µ–Ω—Ç—ã —Å –Ω–∏–∑–∫–∏–º % –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –î–ó.",
        'üë®‚Äçüéì –û—Ç—á–µ—Ç –ø–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º': "üë®‚Äçüéì –ü—Ä–æ–±–ª–µ–º–Ω–∞—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å."
    }

    bot.send_message(
        chat_id,
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {text}\n{descriptions[text]}\n\nüìé –û—Ç–ø—Ä–∞–≤—å—Ç–µ Excel-—Ñ–∞–π–ª."
    )




@bot.message_handler(content_types=['document'])
def handle_file(message):
    chat_id = message.chat.id

    if chat_id not in user_state or user_state[chat_id]["mode"] != "report":
        bot.send_message(chat_id, "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á–µ—Ç.", reply_markup=main_menu())
        return

    report_type = user_state[chat_id]["report_type"]

    bot.send_message(chat_id, "‚è≥ –§–∞–π–ª –ø–æ–ª—É—á–µ–Ω. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...")

    try:
        file_info = bot.get_file(message.document.file_id)
        file_bytes = BytesIO(bot.download_file(file_info.file_path))

        if report_type == 'üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã':
            df_result = count_lessons_per_subject(file_bytes)
        elif report_type == 'üìù –¢–µ–º—ã —É—Ä–æ–∫–æ–≤':
            df_result = Filter_topics_name(file_bytes)
        elif report_type == '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –î–ó':
            df_result = Filter_HomeworkChecked_percentage(file_bytes)
        elif report_type == 'üßë‚Äçüè´ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π':
            df_result = Filter_Teacher_Attendance(file_bytes)
        elif report_type == 'üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è':
            df_result = filter_homework_percentage(file_bytes)
        elif report_type == 'üë®‚Äçüéì –û—Ç—á–µ—Ç –ø–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º':
            df_result = filter_homework_classwork(file_bytes)
        else:
            raise ValueError("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ—Ç—á–µ—Ç–∞")

        preview = format_dataframe_preview(df_result, max_rows=5)
        bot.send_message(chat_id, f"üìä –ü—Ä–µ–≤—å—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:\n\n{preview}")

        result_io = BytesIO()
        df_result.to_excel(result_io, index=False)
        result_io.seek(0)

        bot.send_document(chat_id, ('result.xlsx', result_io))
        bot.send_message(chat_id, "‚úÖ –ì–æ—Ç–æ–≤–æ!", reply_markup=main_menu())

    except Exception as e:
        bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")

    user_state.pop(chat_id, None)




@bot.message_handler(func=lambda m: m.chat.id in user_state and user_state[m.chat.id]["mode"] == "consultant")
def consultant_handler(message):
    chat_id = message.chat.id
    text = message.text.strip()

    try:
        response = ollama.chat(
            model='llama3:latest',
            messages=[
                {
                    "role": "system",
                    "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–ª–ª–µ–¥–∂–∞. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ –¥–µ–ª—É."
                },
                {
                    "role": "user",
                    "content": text
                }
            ],
            options={
                "temperature": 0.2,
                "num_ctx": 4096
            }
        )

        answer = response["message"]["content"]
        bot.send_message(chat_id, answer)

    except Exception as e:
        bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ò–ò: {e}")




@bot.message_handler(func=lambda m: True)
def fallback(message):
    bot.send_message(
        message.chat.id,
        "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.",
        reply_markup=main_menu()
    )




if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    bot.infinity_polling(timeout=30, long_polling_timeout=30)
